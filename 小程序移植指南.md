# Web 版本移植到微信小程序版本 - 详细指南

## 一、准备工作

### 1. 安装微信开发者工具
- 下载地址：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html
- 安装并登录你的微信开发者账号

### 2. 创建小程序项目
1. 打开微信开发者工具
2. 点击"新建项目"
3. 填写信息：
   - **项目名称**：Split-Bill（或你喜欢的名字）
   - **目录**：选择一个空文件夹（例如：`C:\dev\Split-bill-miniapp`）
   - **AppID**：如果有，填写你的小程序 AppID；如果没有，选择"测试号"
   - **开发模式**：选择"小程序"
4. 点击"新建"

### 3. 了解小程序项目结构

小程序项目的基本结构：
```
miniapp/
├── app.js          # 小程序入口文件
├── app.json        # 小程序全局配置
├── app.wxss        # 小程序全局样式
├── pages/          # 页面目录
│   ├── index/      # 首页
│   │   ├── index.js
│   │   ├── index.json
│   │   ├── index.wxml
│   │   └── index.wxss
│   └── ...
├── utils/          # 工具函数目录
└── project.config.json  # 项目配置
```

## 二、创建小程序项目结构

### 步骤 1：创建页面目录

在微信开发者工具中，创建以下页面：

1. **首页（活动列表）**：`pages/home/`
2. **活动详情页**：`pages/activity/`
3. **添加/编辑账单页**：`pages/bill/`
4. **结算页**：`pages/summary/`

### 步骤 2：创建工具函数目录

创建 `utils/` 目录，用于存放公共函数。

## 三、核心代码移植

### 1. 云开发初始化

**文件位置**：`app.js`

```javascript
// app.js
App({
  onLaunch() {
    // 初始化云开发
    if (!wx.cloud) {
      console.error('请使用 2.2.3 或以上的基础库以使用云能力');
    } else {
      wx.cloud.init({
        env: '你的云开发环境ID', // 替换为你的环境ID
        traceUser: true,
      });
    }
    
    // 获取用户信息
    this.getUserInfo();
  },
  
  getUserInfo() {
    // 从本地存储获取用户名
    const userName = wx.getStorageSync('userName');
    if (userName) {
      this.globalData.currentUserName = userName;
    }
  },
  
  globalData: {
    currentUserName: null,
    currentActivity: null,
    currentActivityBills: [],
    currentActivityBalances: {},
  }
});
```

### 2. 数据库操作工具

**文件位置**：`utils/db.js`

```javascript
// utils/db.js
const db = wx.cloud.database();

// 获取当前用户信息
function getCurrentUser() {
  return wx.getStorageSync('userName');
}

// 用户登录/注册
async function loginOrRegister(userName) {
  try {
    // 保存到本地存储
    wx.setStorageSync('userName', userName);
    
    // 检查用户是否存在
    const userRes = await db.collection('users')
      .where({ name: userName })
      .get();
    
    if (userRes.data.length === 0) {
      // 用户不存在，创建新用户
      await db.collection('users').add({
        data: {
          name: userName,
          createdAt: new Date(),
        }
      });
    }
    
    return { success: true, userName };
  } catch (e) {
    console.error('登录失败:', e);
    return { success: false, error: e.message };
  }
}

// 获取活动列表
async function getActivities() {
  const userName = getCurrentUser();
  if (!userName) return [];
  
  try {
    const res = await db.collection('activities')
      .where({
        memberNames: db.command.in([userName])
      })
      .get();
    return res.data;
  } catch (e) {
    console.error('获取活动列表失败:', e);
    return [];
  }
}

// 获取账单列表
async function getBills(activityId) {
  try {
    const res = await db.collection('bills')
      .where({ activityId })
      .orderBy('time', 'desc')
      .get();
    return res.data;
  } catch (e) {
    console.error('获取账单列表失败:', e);
    return [];
  }
}

// 保存账单
async function saveBill(billData) {
  try {
    const userName = getCurrentUser();
    const result = await db.collection('bills').add({
      data: {
        ...billData,
        creator: userName,
        createdAt: new Date(),
      }
    });
    return { success: true, id: result._id };
  } catch (e) {
    console.error('保存账单失败:', e);
    return { success: false, error: e.message };
  }
}

// 更新账单
async function updateBill(billId, billData) {
  try {
    await db.collection('bills').doc(billId).update({
      data: {
        ...billData,
        updatedAt: new Date(),
      }
    });
    return { success: true };
  } catch (e) {
    console.error('更新账单失败:', e);
    return { success: false, error: e.message };
  }
}

// 删除账单
async function deleteBill(billId) {
  try {
    await db.collection('bills').doc(billId).remove();
    return { success: true };
  } catch (e) {
    console.error('删除账单失败:', e);
    return { success: false, error: e.message };
  }
}

module.exports = {
  getCurrentUser,
  loginOrRegister,
  getActivities,
  getBills,
  saveBill,
  updateBill,
  deleteBill,
};
```

### 3. 首页（活动列表）

**文件位置**：`pages/home/home.wxml`

```xml
<!--pages/home/home.wxml-->
<view class="container">
  <view class="header">
    <text class="title">活动列表</text>
    <button class="btn-add" bindtap="createActivity">+ 创建活动</button>
  </view>
  
  <view class="activity-list">
    <view wx:for="{{activities}}" wx:key="_id" class="activity-item" bindtap="openActivity" data-id="{{item._id}}">
      <view class="activity-name">{{item.name}}</view>
      <view class="activity-meta">{{item.type}} | 成员：{{item.memberNames.join('、')}}</view>
    </view>
  </view>
</view>
```

**文件位置**：`pages/home/home.js`

```javascript
// pages/home/home.js
const db = require('../../utils/db.js');

Page({
  data: {
    activities: [],
  },
  
  onLoad() {
    this.loadActivities();
  },
  
  onShow() {
    // 每次显示页面时刷新列表
    this.loadActivities();
  },
  
  async loadActivities() {
    wx.showLoading({ title: '加载中...' });
    const activities = await db.getActivities();
    this.setData({ activities });
    wx.hideLoading();
  },
  
  createActivity() {
    wx.navigateTo({
      url: '/pages/activity/create'
    });
  },
  
  openActivity(e) {
    const activityId = e.currentTarget.dataset.id;
    wx.navigateTo({
      url: `/pages/activity/detail?id=${activityId}`
    });
  },
});
```

### 4. 活动详情页

**文件位置**：`pages/activity/detail.wxml`

```xml
<!--pages/activity/detail.wxml-->
<view class="container">
  <view class="header">
    <text class="title">{{activity.name}}</text>
  </view>
  
  <view class="tabs">
    <view class="tab {{currentTab === 'bills' ? 'active' : ''}}" bindtap="switchTab" data-tab="bills">账单</view>
    <view class="tab {{currentTab === 'summary' ? 'active' : ''}}" bindtap="switchTab" data-tab="summary">结算</view>
  </view>
  
  <!-- 账单 Tab -->
  <view wx:if="{{currentTab === 'bills'}}" class="tab-content">
    <view class="bill-list">
      <view wx:for="{{bills}}" wx:key="_id" class="bill-item" bindtap="viewBill" data-id="{{item._id}}">
        <view class="bill-title">{{item.title}}</view>
        <view class="bill-amount">¥{{item.amount}}</view>
      </view>
    </view>
    <button class="btn-add" bindtap="addBill">+ 添加账单</button>
  </view>
  
  <!-- 结算 Tab -->
  <view wx:if="{{currentTab === 'summary'}}" class="tab-content">
    <view class="summary-content">
      <!-- 结算内容 -->
    </view>
  </view>
</view>
```

## 四、主要差异和注意事项

### 1. API 差异

| Web 版本 | 小程序版本 |
|---------|-----------|
| `document.getElementById()` | `this.setData()` |
| `innerHTML` | `{{}}` 数据绑定 |
| `addEventListener` | `bindtap`、`bindinput` 等 |
| `localStorage` | `wx.getStorageSync()` / `wx.setStorageSync()` |
| `fetch` / `XMLHttpRequest` | `wx.request()` 或云开发 API |

### 2. 样式差异

- Web: CSS 文件
- 小程序: WXSS 文件（类似 CSS，但有一些限制）

### 3. 页面跳转

- Web: 单页应用，通过显示/隐藏元素
- 小程序: 使用 `wx.navigateTo()`、`wx.redirectTo()` 等

### 4. 数据绑定

- Web: 直接操作 DOM
- 小程序: 使用 `this.setData()` 更新数据，WXML 自动更新

## 五、移植步骤总结

1. ✅ **创建小程序项目**（在微信开发者工具中）
2. ✅ **创建页面结构**（home、activity、bill、summary）
3. ✅ **移植工具函数**（数据库操作、计算函数等）
4. ✅ **移植页面逻辑**（逐个页面移植）
5. ✅ **适配样式**（CSS → WXSS）
6. ✅ **测试功能**（登录、活动、账单、结算）
7. ✅ **配置云开发**（环境ID、数据库权限）

## 六、下一步

建议按照以下顺序移植：

1. **第一步**：创建项目结构和基础配置
2. **第二步**：移植登录/注册功能
3. **第三步**：移植活动列表和创建活动
4. **第四步**：移植账单列表和添加账单
5. **第五步**：移植账单编辑和删除
6. **第六步**：移植结算功能
7. **第七步**：优化样式和用户体验

需要我帮你开始第一步吗？




