# 数据库备份功能使用指南（简化版）

## 📋 第一步：准备工作

### 1.1 安装 CloudBase CLI

打开命令行（Windows 用 PowerShell 或 CMD，Mac/Linux 用 Terminal），运行：

```bash
npm install -g @cloudbase/cli
```

如果提示权限错误，Windows 可能需要以管理员身份运行，Mac/Linux 可能需要加 `sudo`。

### 1.2 登录腾讯云

```bash
tcb login
```

会打开浏览器，按提示登录并授权。

## 📦 第二步：部署云函数

### 方式一：使用自动部署脚本（推荐）

**Windows 用户：**
1. 在项目根目录（`C:\dev\Split-bill`）打开命令行
2. 运行：
```bash
deploy-backup.bat
```

**Mac/Linux 用户：**
1. 在项目根目录打开终端
2. 运行：
```bash
chmod +x deploy-backup.sh
./deploy-backup.sh
```

### 方式二：手动部署

如果自动脚本不工作，可以手动执行：

#### 2.1 部署备份云函数

```bash
# 进入备份云函数目录
cd cloudfunctions/database-backup

# 安装依赖
npm install

# 返回项目根目录
cd ../..

# 部署云函数
tcb fn deploy database-backup
```

#### 2.2 部署导入云函数

```bash
# 进入导入云函数目录
cd cloudfunctions/database-import

# 安装依赖
npm install

# 返回项目根目录
cd ../..

# 部署云函数
tcb fn deploy database-import
```

## ⏰ 第三步：配置定时触发器（重要！）

这是让系统每天凌晨3:00自动备份的关键步骤：

### 3.1 打开腾讯云开发控制台

1. 访问：https://console.cloud.tencent.com/tcb
2. 登录你的账号
3. 选择你的环境（就是你在 `index.html` 中配置的 `envId`）

### 3.2 配置备份触发器

1. 点击左侧菜单「云函数」
2. 找到 `database-backup` 函数，点击进入
3. 点击「触发器」标签
4. 点击「新建触发器」按钮
5. 填写配置：
   - **触发方式**：选择「定时触发」
   - **触发周期**：选择「每天」
   - **Cron 表达式**：输入 `0 3 * * *`（表示每天凌晨3:00）
   - **触发名称**：输入 `daily-backup`（可以自定义）
6. 点击「确定」保存

### 3.3 验证触发器

配置完成后，你可以：
- 点击「测试」按钮手动触发一次，测试是否正常工作
- 或者等待第二天凌晨3:00，查看是否自动执行

## 📁 第四步：查看备份文件

### 4.1 在控制台查看

1. 在腾讯云开发控制台，点击「云存储」
2. 查看 `backups` 文件夹
3. 备份文件命名格式：`backup_2024-01-01_00-00-00.json`

### 4.2 下载备份文件

点击文件名即可下载到本地。

## 🔄 第五步：导入备份数据（需要恢复时）

### 方式一：在控制台调用云函数（推荐）

1. 进入「云函数」页面
2. 找到 `database-import` 函数
3. 点击「测试」或「在线调试」
4. 在「测试参数」中输入：

```json
{
  "fileId": "cloud://你的环境ID.xxx/backups/backup_2024-01-01_00-00-00.json",
  "collections": ["users", "activities", "bills"],
  "mode": "merge"
}
```

**参数说明：**
- `fileId`: 从云存储页面复制备份文件的完整路径
- `collections`: 要导入的集合，不填则导入所有
- `mode`: 
  - `merge` - 合并模式（推荐，不会覆盖现有数据）
  - `replace` - 替换模式（需要先手动清空集合）

5. 点击「测试」执行

### 方式二：使用命令行

```bash
tcb fn invoke database-import --params '{
  "fileId": "cloud://你的环境ID.xxx/backups/backup_2024-01-01_00-00-00.json",
  "mode": "merge"
}'
```

## ❓ 常见问题

### Q1: 部署时提示找不到命令 `tcb`

**解决：** 确保已安装 CloudBase CLI：
```bash
npm install -g @cloudbase/cli
```

### Q2: 部署时提示登录失败

**解决：** 重新登录：
```bash
tcb login
```

### Q3: 触发器配置后没有自动执行

**检查：**
1. Cron 表达式是否正确：`0 3 * * *`
2. 触发器是否已启用
3. 查看云函数执行日志，看是否有错误

### Q4: 备份文件在哪里？

**位置：** 云存储的 `backups` 文件夹

### Q5: 如何修改备份时间？

**方法：** 在触发器配置中修改 Cron 表达式：
- `0 3 * * *` - 每天凌晨3:00
- `0 0 * * *` - 每天凌晨0:00
- `0 */6 * * *` - 每6小时
- `0 0 * * 0` - 每周日凌晨0:00

### Q6: 如何删除旧备份？

**说明：** 系统会自动删除7天前的备份。如需修改保留天数，编辑 `cloudfunctions/database-backup/index.js` 文件，找到：
```javascript
await cleanupOldBackups(storage, 7); // 修改这里的数字
```

## 📝 备份文件格式说明

备份文件是 JSON 格式，包含：
- `timestamp`: 备份时间
- `collections`: 各集合的数据
  - `users`: 用户数据
  - `activities`: 活动数据
  - `groups`: 群组数据
  - `bills`: 费用数据
  - `customActivityTypes`: 自定义类型数据

## ⚠️ 重要提示

1. **首次部署后**，建议手动触发一次测试，确保正常工作
2. **定期检查**备份文件是否正常生成
3. **重要操作前**（如导入数据），建议先备份当前数据
4. **导入数据时**，建议先用 `merge` 模式测试，确认无误后再用 `replace` 模式

## 🎯 快速检查清单

- [ ] 已安装 CloudBase CLI
- [ ] 已登录腾讯云（`tcb login`）
- [ ] 已部署 `database-backup` 云函数
- [ ] 已部署 `database-import` 云函数
- [ ] 已配置定时触发器（Cron: `0 3 * * *`）
- [ ] 已测试手动触发备份
- [ ] 已确认备份文件生成在云存储中

完成以上步骤后，系统就会每天凌晨3:00自动备份你的数据库了！


