<!--pages/activity/detail.wxml-->
<view class="container">
  <view class="header">
    <view class="activity-header">
      <view class="activity-title-row">
        <view class="activity-title">
          {{activity.name}}
          <text wx:if="{{isPrepaid}}" class="prepaid-tag">（打平伙）</text>
        </view>
        <button class="btn-edit-activity {{isCreator ? '' : 'disabled'}}" size="mini" bindtap="editActivity" disabled="{{!isCreator}}">编辑</button>
      </view>
      <view class="activity-creator" wx:if="{{activity.creator}}">
        <text>创建者：<text class="creator-name">{{activity.creator}}</text></text>
        <text wx:if="{{isPrepaid && keeper}}" class="keeper-info">保管者：<text class="keeper-name">{{keeper}}</text></text>
      </view>
    </view>
    <view class="activity-meta">{{activityMeta}}</view>
    
    <!-- 结算信息 -->
    <view class="summary-info">
      <view class="summary-info-item">
        <text class="summary-label">总支出：</text>
        <text class="summary-value amount">¥{{total}}</text>
      </view>
      <view class="summary-info-item">
        <text class="summary-label">{{dateRange}} | 账单数量：{{bills.length}} 条</text>
      </view>
    </view>
  </view>
  
  <view class="tabs">
    <view class="tab {{currentTab === 'bills' ? 'active' : ''}}" bindtap="switchTab" data-tab="bills">账单</view>
    <view wx:if="{{isPrepaid}}" class="tab {{currentTab === 'recharge' ? 'active' : ''}}" bindtap="switchTab" data-tab="recharge">打平伙</view>
    <view class="tab {{currentTab === 'summary' ? 'active' : ''}}" bindtap="switchTab" data-tab="summary">结算</view>
  </view>
  
  <!-- 账单 Tab -->
  <view wx:if="{{currentTab === 'bills'}}" class="tab-content">
    <view class="bill-list">
      <view wx:if="{{bills.length === 0}}" class="empty-tip">
        <text>暂无账单记录</text>
      </view>
      
      <view wx:for="{{bills}}" wx:key="_id" class="bill-item" bindtap="viewBill" data-bill="{{item}}">
        <view class="bill-left">
          <view class="bill-circles">
            <view wx:for="{{item.circles}}" wx:key="index" wx:for-item="circle" class="circle {{circle.type}}" style="margin-left: {{circle.marginLeft}}; {{circle.type === 'pie' ? '' : (circle.type === 'split' ? '' : 'background-color: ' + circle.color + ';')}}">
              <view wx:if="{{circle.type === 'pie'}}" class="circle-pie">
                <canvas type="2d" id="pieCanvas_{{item._id}}" class="pie-canvas" data-sectors="{{circle.sectors}}"></canvas>
              </view>
              <text wx:if="{{circle.surname && circle.type !== 'pie' && circle.type !== 'split'}}">{{circle.surname}}</text>
            </view>
          </view>
          <view class="bill-weight">{{item.totalCount}}</view>
          <view class="bill-info">
            <view class="bill-title">{{item.title}}</view>
            <view class="bill-date">{{item.date}}</view>
          </view>
        </view>
        <view class="bill-right">
          <view class="bill-amount">¥{{item.amount}}</view>
          <button wx:if="{{item.isCreator}}" class="btn-delete" size="mini" catchtap="deleteBill" data-id="{{item._id}}" data-title="{{item.title}}">删除</button>
        </view>
      </view>
    </view>
    <button class="btn-add" bindtap="addBill">+ 添加账单</button>
  </view>
  
  <!-- 打平伙 Tab -->
  <view wx:if="{{currentTab === 'recharge' && isPrepaid}}" class="tab-content">
    <view class="recharge-content">
      <view class="recharge-summary">
        <view class="recharge-summary-item">
          <text class="recharge-label">充值总金额：</text>
          <text class="recharge-value amount">¥{{totalRecharge}}</text>
        </view>
      </view>
      
      <view class="recharge-list">
        <view wx:if="{{recharges.length === 0}}" class="empty-tip">
          <text>暂无充值记录</text>
        </view>
        
        <!-- 表头 -->
        <view wx:if="{{recharges.length > 0}}" class="recharge-header">
          <view class="recharge-header-item">日期</view>
          <view class="recharge-header-item">充值人员</view>
          <view class="recharge-header-item">金额</view>
          <view class="recharge-header-item">记录人</view>
          <view class="recharge-header-item">操作</view>
        </view>
        
        <view wx:for="{{recharges}}" wx:key="_id" class="recharge-item">
          <view class="recharge-info">
            <view class="recharge-date">{{item.date}}</view>
            <view class="recharge-payer">{{item.payer}}</view>
            <view class="recharge-amount">¥{{item.amount}}</view>
            <view class="recharge-recorder">{{item.recorder || item.creator}}</view>
          </view>
          <button class="btn-delete {{item.isCreator ? '' : 'disabled'}}" size="mini" catchtap="deleteRecharge" disabled="{{!item.isCreator}}" data-id="{{item._id}}" data-payer="{{item.payer}}" data-amount="{{item.amount}}">删除</button>
        </view>
      </view>
      
      <button class="btn-add" bindtap="addRecharge">+ 添加充值</button>
    </view>
  </view>
  
  <!-- 结算 Tab -->
  <view wx:if="{{currentTab === 'summary'}}" class="tab-content">
    <view class="summary-content">
      <!-- 打平伙活动的特殊显示 -->
      <view wx:if="{{isPrepaid}}" class="prepaid-summary">
        <view class="prepaid-item">
          <text class="prepaid-label">总金额（充值）：</text>
          <text class="prepaid-value amount">¥{{totalRecharge}}</text>
        </view>
        <view class="prepaid-item">
          <text class="prepaid-label">消费金额：</text>
          <text class="prepaid-value">¥{{totalConsume}}</text>
        </view>
        <view class="prepaid-item">
          <text class="prepaid-label">剩余金额：</text>
          <text class="prepaid-value {{remaining < 0 ? 'negative' : 'positive'}}">¥{{remaining}}</text>
        </view>
        <view wx:if="{{remaining < 0}}" class="recharge-alert">
          <text class="alert-text">⚠️ 余额不足，请及时充值！</text>
        </view>
      </view>
      
      <view class="member-list">
        <view wx:for="{{members}}" wx:key="name" class="member-item" bindtap="onMemberTap" data-name="{{item.name}}">
          <view class="member-info">
            <view class="member-name">{{item.name}}</view>
            <view class="member-detail">
              实付：¥{{item.bal.paid}} | 应付：¥{{item.bal.shouldPay}}
            </view>
          </view>
          <view class="member-balance {{item.bal.balance < 0 ? 'negative' : 'positive'}}">
            余额：¥{{item.bal.balance}}
          </view>
        </view>
      </view>
      
      <view wx:if="{{suggestionMember && !isPrepaid}}" class="suggestion-card">
        <view class="suggestion-title">建议下一次买单人员</view>
        <view class="suggestion-content">
          <text class="suggestion-name">{{suggestionMember.name}}</text> 应付：¥{{suggestionMember.shouldPay}}，实付：¥{{suggestionMember.paid}}
        </view>
      </view>
    </view>
  </view>

    <!-- 成员账单列表弹层 -->
    <view wx:if="{{showMemberBills}}" class="modal-mask" catchtouchmove="noop">
      <view class="modal">
        <view class="modal-header">
          <text>{{selectedMemberName}} 账单明细</text>
          <text class="modal-close" bindtap="closeMemberBills">×</text>
        </view>
        <scroll-view class="modal-body" scroll-y="true" show-scrollbar="{{false}}">
          <!-- 汇总信息 -->
          <view class="summary-section">
            <view class="summary-row">
              <text class="summary-label">收入：</text>
              <text class="summary-value income">¥{{selectedMemberIncome}}</text>
            </view>
            <view class="summary-row">
              <text class="summary-label">支出：</text>
              <text class="summary-value expense">¥{{selectedMemberExpense}}</text>
            </view>
            <view class="summary-row">
              <text class="summary-label">余额：</text>
              <text class="summary-value balance {{selectedMemberBalance >= 0 ? 'positive' : 'negative'}}">¥{{selectedMemberBalance}}</text>
            </view>
          </view>
          
          <!-- 收入账单列表 -->
          <view class="bill-section">
            <view class="section-title">收入</view>
            <view wx:if="{{selectedMemberBills.length === 0}}" class="empty-tip">暂无收入账单</view>
            <view wx:if="{{selectedMemberBills.length > 0}}" class="bill-table">
              <view class="bill-table-header">
                <text class="col-name">名称</text>
                <text class="col-payer">付款人</text>
                <text class="col-total">总金额</text>
                <text class="col-user">应付</text>
                <text class="col-date">日期</text>
              </view>
              <view wx:for="{{selectedMemberBills}}" wx:key="index" class="bill-table-row" bindtap="openBillFromModal" data-id="{{item._id}}">
                <text class="col-name">{{item.title}}</text>
                <text class="col-payer">{{item.payer}}</text>
                <text class="col-total">¥{{item.totalAmount}}</text>
                <text class="col-user">¥{{item.userAmount}}</text>
                <text class="col-date">{{item.date}}</text>
              </view>
            </view>
          </view>
          
          <!-- 支出账单列表 -->
          <view class="bill-section">
            <view class="section-title">支出</view>
            <view wx:if="{{selectedMemberPaidBills.length === 0}}" class="empty-tip">暂无支出账单</view>
            <view wx:if="{{selectedMemberPaidBills.length > 0}}" class="bill-table">
              <view class="bill-table-header">
                <text class="col-name">名称</text>
                <text class="col-payee">收款人</text>
                <text class="col-total">总金额</text>
                <text class="col-date">日期</text>
              </view>
              <view wx:for="{{selectedMemberPaidBills}}" wx:key="index" class="bill-table-row" bindtap="openBillFromModal" data-id="{{item._id}}">
                <text class="col-name">{{item.title}}</text>
                <text class="col-payee">{{item.payee}}</text>
                <text class="col-total">¥{{item.totalAmount}}</text>
                <text class="col-date">{{item.date}}</text>
              </view>
            </view>
          </view>
          <!-- 底部空行防止内容被裁切 -->
          <view class="modal-spacer"></view>
        </scroll-view>
      </view>
    </view>
</view>


